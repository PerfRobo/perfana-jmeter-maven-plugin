<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PerfanaClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">perfana-jmeter-maven-plugin</a> &gt; <a href="index.source.html" class="el_package">com.lazerycode.jmeter.mojo</a> &gt; <span class="el_source">PerfanaClient.java</span></div><h1>PerfanaClient.java</h1><pre class="source lang-java linenums">package com.lazerycode.jmeter.mojo;

import net.minidev.json.JSONArray;

import net.minidev.json.JSONObject;
import okhttp3.*;
import org.apache.maven.plugin.MojoExecutionException;

import java.io.IOException;
import java.net.URLEncoder;
import java.util.Enumeration;
import java.util.Properties;

import static java.lang.Integer.parseInt;

public class PerfanaClient {

<span class="nc" id="L18">    private Logger logger = new SystemOutLogger();</span>

<span class="nc" id="L20">    private static final MediaType JSON</span>
<span class="nc" id="L21">            = MediaType.parse(&quot;application/json; charset=utf-8&quot;);</span>

<span class="nc" id="L23">    private final OkHttpClient client = new OkHttpClient();</span>

    private final String application;
    private final String testType;
    private final String testEnvironment;
    private final String testRunId;
    private final String CIBuildResultsUrl;
    private final String applicationRelease;
    private final String perfanaUrl;
    private final String rampupTimeSeconds;
    private final String plannedDurationInSeconds;
    private final String annotations;
    private final Properties variables;

<span class="nc" id="L37">    public PerfanaClient(String application, String testType, String testEnvironment, String testRunId, String CIBuildResultsUrl, String applicationRelease, String rampupTimeInSeconds, String constantLoadTimeInSeconds, String perfanaUrl, String annotations, Properties variables) {</span>
<span class="nc" id="L38">        this.application = application;</span>
<span class="nc" id="L39">        this.testType = testType;</span>
<span class="nc" id="L40">        this.testEnvironment = testEnvironment;</span>
<span class="nc" id="L41">        this.testRunId = testRunId;</span>
<span class="nc" id="L42">        this.CIBuildResultsUrl = CIBuildResultsUrl;</span>
<span class="nc" id="L43">        this.applicationRelease = applicationRelease;</span>
<span class="nc" id="L44">        this.rampupTimeSeconds = rampupTimeInSeconds;</span>
<span class="nc" id="L45">        this.plannedDurationInSeconds = String.valueOf(parseInt(rampupTimeInSeconds) + parseInt(constantLoadTimeInSeconds));</span>
<span class="nc" id="L46">        this.perfanaUrl = perfanaUrl;</span>
<span class="nc" id="L47">        this.annotations = annotations;</span>
<span class="nc" id="L48">        this.variables = variables;</span>
<span class="nc" id="L49">    }</span>

    public void injectLogger(Logger logger) {
<span class="nc" id="L52">        this.logger = logger;</span>
<span class="nc" id="L53">    }</span>

    public void callPerfana(Boolean completed) {
<span class="nc" id="L56">        String json = perfanaJson(application, testType, testEnvironment, testRunId, CIBuildResultsUrl, applicationRelease, rampupTimeSeconds, plannedDurationInSeconds, annotations, variables, completed);</span>
<span class="nc" id="L57">        logger.debug(String.join(&quot; &quot;, &quot;Call to endpoint:&quot;, perfanaUrl, &quot;with json:&quot;, json));</span>
        try {
<span class="nc" id="L59">            String result = post(perfanaUrl + &quot;/test&quot;, json);</span>
<span class="nc" id="L60">            logger.debug(&quot;Result: &quot; + result);</span>
<span class="nc" id="L61">        } catch (IOException e) {</span>
<span class="nc" id="L62">            logger.error(&quot;Failed to call perfana: &quot; + e.getMessage());</span>
<span class="nc" id="L63">        }</span>
<span class="nc" id="L64">    }</span>

    private String post(String url, String json) throws IOException {
<span class="nc" id="L67">        RequestBody body = RequestBody.create(JSON, json);</span>
<span class="nc" id="L68">        Request request = new Request.Builder()</span>
<span class="nc" id="L69">                .url(url)</span>
<span class="nc" id="L70">                .post(body)</span>
<span class="nc" id="L71">                .build();</span>
<span class="nc" id="L72">        try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L73">            ResponseBody responseBody = response.body();</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">            return responseBody == null ? &quot;null&quot; : responseBody.string();</span>
        }
    }

    private String perfanaJson(String application, String testType, String testEnvironment, String testRunId, String CIBuildResultsUrl, String applicationRelease, String rampupTimeSeconds, String plannedDurationInSeconds, String annotations, Properties variables, Boolean completed) {

<span class="nc" id="L80">        JSONObject perfanaJson = new JSONObject();</span>

        /* If variables parameter exists add them to the json */

<span class="nc bnc" id="L84" title="All 4 branches missed.">        if(variables != null &amp;&amp; !variables.isEmpty()) {</span>

<span class="nc" id="L86">            JSONArray variablesArrayJson = new JSONArray();</span>

<span class="nc" id="L88">            Enumeration&lt;?&gt; enumeration = variables.propertyNames();</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">            while (enumeration.hasMoreElements()) {</span>
<span class="nc" id="L90">                String name = (String) enumeration.nextElement();</span>
<span class="nc" id="L91">                String value = (String) variables.get(name);</span>
<span class="nc" id="L92">                JSONObject variablesJson = new JSONObject();</span>
<span class="nc" id="L93">                variablesJson.put(&quot;placeholder&quot;, name);</span>
<span class="nc" id="L94">                variablesJson.put(&quot;value&quot;, value);</span>
<span class="nc" id="L95">                variablesArrayJson.add(variablesJson);</span>
<span class="nc" id="L96">            }</span>

<span class="nc" id="L98">            perfanaJson.put(&quot;variables&quot;, variablesArrayJson);</span>
        }

        /* If annotations are passed add them to the json */

<span class="nc bnc" id="L103" title="All 4 branches missed.">        if(!&quot;&quot;.equals(annotations) &amp;&amp; annotations != null ){</span>

<span class="nc" id="L105">            perfanaJson.put(&quot;annotations&quot;, annotations);</span>

        }

<span class="nc" id="L109">        perfanaJson.put(&quot;testRunId&quot;, testRunId);</span>
<span class="nc" id="L110">        perfanaJson.put(&quot;testType&quot;, testType);</span>
<span class="nc" id="L111">        perfanaJson.put(&quot;testEnvironment&quot;, testEnvironment);</span>
<span class="nc" id="L112">        perfanaJson.put(&quot;application&quot;, application);</span>
<span class="nc" id="L113">        perfanaJson.put(&quot;applicationRelease&quot;, applicationRelease);</span>
<span class="nc" id="L114">        perfanaJson.put(&quot;CIBuildResultsUrl&quot;, CIBuildResultsUrl);</span>
<span class="nc" id="L115">        perfanaJson.put(&quot;rampUp&quot;, rampupTimeSeconds);</span>
<span class="nc" id="L116">        perfanaJson.put(&quot;duration&quot;, plannedDurationInSeconds);</span>
<span class="nc" id="L117">        perfanaJson.put(&quot;completed&quot;, completed);</span>

<span class="nc" id="L119">        return perfanaJson.toJSONString();</span>


    }

    /**
     * Call asserts for this test run.
     * @return json string such as {&quot;meetsRequirement&quot;:true,&quot;benchmarkResultPreviousOK&quot;:true,&quot;benchmarkResultFixedOK&quot;:true}
     * @throws IOException when call fails
     */
    public String callCheckAsserts() throws IOException, MojoExecutionException {
        // example: https://targets-io.com/benchmarks/DASHBOARD/NIGHTLY/TEST-RUN-831
<span class="nc" id="L131">        String url = String.join(&quot;/&quot;, perfanaUrl, &quot;get-benchmark-results&quot;, URLEncoder.encode(application, &quot;UTF-8&quot;).replaceAll(&quot;\\+&quot;, &quot;%20&quot;), URLEncoder.encode(testRunId, &quot;UTF-8&quot;).replaceAll(&quot;\\+&quot;, &quot;%20&quot;) );</span>
<span class="nc" id="L132">        Request request = new Request.Builder()</span>
<span class="nc" id="L133">                .url(url)</span>
<span class="nc" id="L134">                .get()</span>
<span class="nc" id="L135">                .build();</span>

<span class="nc" id="L137">        int retries = 0;</span>
<span class="nc" id="L138">        final int MAX_RETRIES = 12;</span>
<span class="nc" id="L139">        final long sleepInMillis = 10000;</span>
<span class="nc" id="L140">        String assertions = null;</span>

<span class="nc bnc" id="L142" title="All 2 branches missed.">        while (retries &lt;= MAX_RETRIES) {</span>
<span class="nc" id="L143">            try (Response response = client.newCall(request).execute()) {</span>

<span class="nc" id="L145">                ResponseBody responseBody = response.body();</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                if (response.code() == 200) {</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                    assertions = responseBody == null ? &quot;null&quot; : responseBody.string();</span>
                    break;
                } else {
<span class="nc bnc" id="L150" title="All 2 branches missed.">                    String message = responseBody == null ? response.message() : responseBody.string();</span>
<span class="nc" id="L151">                    logger.warn(&quot;failed to retrieve assertions for url [&quot; + url + &quot;] code [&quot; + response.code() + &quot;] retry [&quot; + retries + &quot;/&quot; + MAX_RETRIES + &quot;] &quot; + message);</span>
                }
                try {
<span class="nc" id="L154">                    Thread.sleep(sleepInMillis);</span>
<span class="nc" id="L155">                } catch (InterruptedException e) {</span>
                    // ignore
<span class="nc" id="L157">                }</span>
<span class="nc" id="L158">                retries = retries + 1;</span>
            }
<span class="nc bnc" id="L160" title="All 2 branches missed.">            if (retries == MAX_RETRIES) {</span>
<span class="nc" id="L161">                throw new MojoExecutionException(&quot;Unable to retrieve assertions for url [&quot; + url + &quot;]&quot;);</span>
            }
        }
<span class="nc" id="L164">        return assertions;</span>
    }



    public static class KeepAliveRunner implements Runnable {

        private final PerfanaClient client;

<span class="nc" id="L173">        public KeepAliveRunner(PerfanaClient client) {</span>
<span class="nc" id="L174">            this.client = client;</span>
<span class="nc" id="L175">        }</span>

        @Override
        public void run() {
<span class="nc" id="L179">            client.callPerfana(false);</span>
<span class="nc" id="L180">        }</span>
    }

    public interface Logger {
        void info(String message);
        void warn(String message);
        void error(String message);
        void debug(String message);
    }

<span class="nc" id="L190">    public static class SystemOutLogger implements Logger {</span>
        public void info(String message) {
<span class="nc" id="L192">            System.out.println(&quot;INFO:  &quot; + message);</span>
<span class="nc" id="L193">        }</span>

        public void warn(String message) {
<span class="nc" id="L196">            System.out.println(&quot;WARN:  &quot; + message);</span>
<span class="nc" id="L197">        }</span>

        public void error(String message) {
<span class="nc" id="L200">            System.out.println(&quot;ERROR: &quot; + message);</span>
<span class="nc" id="L201">        }</span>

        public void debug(String message) {
<span class="nc" id="L204">            System.out.println(&quot;DEBUG: &quot; + message);</span>
<span class="nc" id="L205">        }</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>